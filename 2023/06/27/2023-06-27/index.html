<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>时间序列（二）——复现ARIMA预测AirPassenger | vbrun-lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1.1ARIMA模型拆解  AR(自回归项)、I(差分项)和MA(移动平均项)： AR项是指用于预测下一个值的过去值。AR项由ARIMA中的参数p定义。p值是由PACF图确定的。 MA项定义了预测未来值时过去预测误差的数目。ARIMA中的参数q代表MA项。ACF图用于识别正确的q值 差分顺序规定了对序列执行差分操作的次数，对数据进行差分操作的目的是使之保持平稳。ADF可以用来确定序列是否是平稳的，">
<meta property="og:type" content="article">
<meta property="og:title" content="时间序列（二）——复现ARIMA预测AirPassenger">
<meta property="og:url" content="https://vbrun-lab.github.io/2023/06/27/2023-06-27/index.html">
<meta property="og:site_name" content="vbrun-lab">
<meta property="og:description" content="1.1ARIMA模型拆解  AR(自回归项)、I(差分项)和MA(移动平均项)： AR项是指用于预测下一个值的过去值。AR项由ARIMA中的参数p定义。p值是由PACF图确定的。 MA项定义了预测未来值时过去预测误差的数目。ARIMA中的参数q代表MA项。ACF图用于识别正确的q值 差分顺序规定了对序列执行差分操作的次数，对数据进行差分操作的目的是使之保持平稳。ADF可以用来确定序列是否是平稳的，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://vbrun-lab.github.io/images/time.png">
<meta property="og:image" content="https://vbrun-lab.github.io/images/time2.png">
<meta property="og:image" content="https://vbrun-lab.github.io/images/time5.png">
<meta property="og:image" content="https://vbrun-lab.github.io/images/time6.png">
<meta property="og:image" content="https://vbrun-lab.github.io/images/time3.png">
<meta property="og:image" content="https://vbrun-lab.github.io/images/time4.png">
<meta property="article:published_time" content="2023-06-27T00:40:39.000Z">
<meta property="article:modified_time" content="2023-07-07T14:34:44.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="时间序列">
<meta property="article:tag" content="机器学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://vbrun-lab.github.io/images/time.png">
  
    <link rel="alternate" href="/atom.xml" title="vbrun-lab" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">vbrun-lab</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://vbrun-lab.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2023-06-27" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/06/27/2023-06-27/" class="article-date">
  <time class="dt-published" datetime="2023-06-27T00:40:39.000Z" itemprop="datePublished">2023-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      时间序列（二）——复现ARIMA预测AirPassenger
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>1.1ARIMA模型拆解</strong></p>
<ul>
<li>AR(自回归项)、I(差分项)和MA(移动平均项)：</li>
<li>AR项是指用于预测下一个值的过去值。AR项由ARIMA中的参数p定义。p值是由PACF图确定的。</li>
<li>MA项定义了预测未来值时过去预测误差的数目。ARIMA中的参数q代表MA项。ACF图用于识别正确的q值</li>
<li>差分顺序规定了对序列执行差分操作的次数，对数据进行差分操作的目的是使之保持平稳。ADF可以用来确定序列是否是平稳的，并有助于识别d值。</li>
</ul>
<p><strong>1.2 模型基本步骤</strong></p>
<p><strong>1.21 序列平稳化检验，确定d值</strong></p>
<p>对序列绘图，进行 ADF 检验，观察序列是否平稳（一般为不平稳）；对于非平稳时间序列要先进行 d 阶差分，转化为平稳时间序列</p>
<p>对于白噪声序列，基本是在均值附近较为平均的随机震荡。它满足正态分布，均值与方差都是与时间t无关的函数，它满足平稳性要求。</p>
<p><strong>1.22 确定p值和q值</strong></p>
<p>(1)p 值可从偏自相关系数（PACF）图的最大滞后点来大致判断，q 值可从自相关系数（ACF）图的最大滞后点来大致判断</p>
<p>拖尾，顾名思义，就是序列缓慢衰减，“尾巴”慢慢拖着滑下来，或者震荡衰减；而截尾则是突然截断了，像个悬崖，指序列从某个时点变得非常小。</p>
<p>​                            <strong>下面是原时间序列、一阶差分后、二阶差分后的acf图：</strong></p>
<p><img src="/images/time.png" alt="time"></p>
<p>可以看到，原序列的acf图的拖尾阶数过高了，而二阶差分后的截尾阶数过小了，所以一阶差分更合适。</p>
<p>(2)遍历搜索AIC和BIC最小的参数组合</p>
<p>一般可以通过计算AIC或BIC的方式来找出更好的阶数组合。通过预测结果来推断模型阶数的好坏毕竟还是耗时耗力了些，一般可以通过计算AIC或BIC的方式来找出更好的阶数组合。pmdarima模块的auto_arima方法就可以让我们指定一个阶数上限和信息准则计算方法，从而找到信息准则最小的阶数组合。</p>
<p><strong>1.3 拟合ARIMA模型 (p,d,q)</strong></p>
<p>model &#x3D; ARIMA(ts_log, order&#x3D;(2, 1, 2)) </p>
<p>results_ARIMA &#x3D; model.fit()</p>
<p><strong>1.4 预测未来的值</strong></p>
<p>样本外预测，forecast方法:arma_model.forecast(steps&#x3D;1, exog&#x3D;None, alpha&#x3D;0.05)</p>
<p>样本内和样本外预测，predict方法，arma_model.predict(start&#x3D;None, end&#x3D;None, exog&#x3D;None, dynamic&#x3D;False)</p>
<p><strong>使用对数消除趋势，预测后还原，更准</strong></p>
<h4 id="例子：分析航空数据AirPassenger"><a href="#例子：分析航空数据AirPassenger" class="headerlink" title="例子：分析航空数据AirPassenger"></a>例子：分析航空数据<a target="_blank" rel="noopener" href="https://github.com/AileenNielsen/TimeSeriesAnalysisWithPython/blob/master/data/AirPassengers.csv">AirPassenger</a></h4><p>数据内容：</p>
<table>
<thead>
<tr>
<th>Month</th>
<th>#Passengers</th>
</tr>
</thead>
<tbody><tr>
<td>1949-01</td>
<td>112</td>
</tr>
<tr>
<td>1949-02</td>
<td>118</td>
</tr>
<tr>
<td>1949-03</td>
<td>132</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import pandas as pd</span><br><span class="line">import numpy as np</span><br><span class="line">import matplotlib.pylab as plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"><span class="comment"># 解决坐标轴刻度负号乱码</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = False</span><br><span class="line"><span class="comment"># 解决中文乱码问题</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;Simhei&#x27;</span>]</span><br><span class="line"></span><br><span class="line">from matplotlib.pylab import rcParams</span><br><span class="line">rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>] = 20, 6</span><br><span class="line"></span><br><span class="line">import warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#方式一：</span></span><br><span class="line"><span class="comment"># 读取数据，pd.read_csv默认生成DataFrame对象，需将其转换成Series对象</span></span><br><span class="line"><span class="built_in">df</span> = pd.read_csv(<span class="string">&#x27;AirPassengers.csv&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, index_col=<span class="string">&#x27;Month&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(df.head())</span><br><span class="line">df.index = pd.to_datetime(df.index)  <span class="comment"># 将字符串索引转换成时间索引</span></span><br><span class="line"><span class="built_in">print</span>(df.head())</span><br><span class="line">ts = <span class="built_in">df</span>[<span class="string">&#x27;#Passengers&#x27;</span>]  <span class="comment"># 生成pd.Series对象</span></span><br><span class="line"><span class="comment"># 查看数据格式</span></span><br><span class="line"><span class="built_in">print</span>(ts.head())</span><br><span class="line"><span class="built_in">print</span>(ts.head().index)</span><br></pre></td></tr></table></figure>

<h4 id="平稳性检测"><a href="#平稳性检测" class="headerlink" title="平稳性检测"></a>平稳性检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;平稳性检验&#x27;</span>)</span><br><span class="line"></span><br><span class="line">from statsmodels.tsa.stattools import adfuller</span><br><span class="line"></span><br><span class="line">def test_stationarity(timeseries):</span><br><span class="line">    <span class="comment"># Determing rolling statistics</span></span><br><span class="line">    rolmean = timeseries.rolling(window=12, center=False).mean()</span><br><span class="line">    rolstd =  timeseries.rolling(window=12, center=False).std()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Plot rolling statistics:</span></span><br><span class="line">    orig = plt.plot(timeseries, color=<span class="string">&#x27;blue&#x27;</span>, label=<span class="string">&#x27;Original&#x27;</span>)</span><br><span class="line">    mean = plt.plot(rolmean, color=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;Rolling Mean&#x27;</span>)</span><br><span class="line">    std = plt.plot(rolstd, color=<span class="string">&#x27;black&#x27;</span>, label = <span class="string">&#x27;Rolling Std&#x27;</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Rolling Mean &amp; Standard Deviation&#x27;</span>)</span><br><span class="line">    plt.show(block=False)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Perform Dickey-Fuller test:</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Results of Dickey-Fuller Test:&#x27;</span>)</span><br><span class="line">    dftest = adfuller(timeseries, autolag=<span class="string">&#x27;AIC&#x27;</span>)</span><br><span class="line">    dfoutput = pd.Series(dftest[0:4], index=[<span class="string">&#x27;Test Statistic&#x27;</span>,<span class="string">&#x27;p-value&#x27;</span>,<span class="string">&#x27;#Lags Used&#x27;</span>,<span class="string">&#x27;Number of Observations Used&#x27;</span>])</span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> dftest[4].items():</span><br><span class="line">        dfoutput[<span class="string">&#x27;Critical Value (&#123;&#125;)&#x27;</span>.format(key)] = value</span><br><span class="line">    <span class="built_in">print</span>(dfoutput)</span><br><span class="line"></span><br><span class="line">test_stationarity(ts)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Results of Dickey-Fuller Test:</span><br><span class="line">Test Statistic                   0.815369</span><br><span class="line">p-value                          0.991880</span><br><span class="line">#Lags Used                      13.000000</span><br><span class="line">Number of Observations Used    130.000000</span><br><span class="line">Critical Value (1%)             -3.481682</span><br><span class="line">Critical Value (5%)             -2.884042</span><br><span class="line">Critical Value (10%)            -2.578770</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p><strong>p &#x3D; 0.991880 &gt; 0.05 序列非平稳, 同时也可以注意到均值和方差很不稳定</strong></p>
<h4 id="白噪声检测"><a href="#白噪声检测" class="headerlink" title="白噪声检测"></a>白噪声检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from statsmodels.stats.diagnostic import acorr_ljungbox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 白噪声检验：Ljung-Box test</span></span><br><span class="line">def randomness(ts, lags=10):</span><br><span class="line">    rdtest = acorr_ljungbox(ts,lags=lags)</span><br><span class="line">    <span class="comment"># 对上述函数求得的值进行语义描述</span></span><br><span class="line">    rddata = np.c_[range(1,lags+1),rdtest[1:][0]]</span><br><span class="line">    rdoutput = pd.DataFrame(rddata,columns=[<span class="string">&#x27;lags&#x27;</span>,<span class="string">&#x27;p-value&#x27;</span>])</span><br><span class="line">    <span class="built_in">return</span> rdoutput.set_index(<span class="string">&#x27;lags&#x27;</span>)</span><br><span class="line"></span><br><span class="line">randomness(ts)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>lags</th>
<th><strong>p-value</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1.0</td>
<td>1.393231e-30</td>
</tr>
<tr>
<td>2.0</td>
<td>4.556318e-54</td>
</tr>
<tr>
<td>3.0</td>
<td>5.751088e-74</td>
</tr>
<tr>
<td>4.0</td>
<td>2.817731e-91</td>
</tr>
<tr>
<td>5.0</td>
<td>7.360195e-107</td>
</tr>
<tr>
<td>6.0</td>
<td>4.264008e-121</td>
</tr>
<tr>
<td>7.0</td>
<td>1.305463e-134</td>
</tr>
<tr>
<td>8.0</td>
<td>6.496271e-148</td>
</tr>
<tr>
<td>9.0</td>
<td>5.249370e-162</td>
</tr>
<tr>
<td>10.0</td>
<td>1.100789e-177</td>
</tr>
</tbody></table>
<p><strong>p &#x3D; 1.3932314e-30 &lt; 0.05，序列为非白噪声序列</strong></p>
<h4 id="平稳性处理-估计和消除趋势"><a href="#平稳性处理-估计和消除趋势" class="headerlink" title="平稳性处理- 估计和消除趋势"></a>平稳性处理- 估计和消除趋势</h4><p>消除趋势的第一个诀窍是对数变换。因为，能清楚地看到我们的数据呈现一个显著的上升趋势。因此，我们可以应用log变换。当然还有其他的变换方式，如：平方根，立方根等等</p>
<p><em><strong>方法一：平滑法&#x2F;移动平均法(Moving average)</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ts_log = np.log(ts) #对数变换(log transform)</span><br><span class="line">moving_avg = ts_log.rolling(window=12,center=False).mean()  # 窗口为12,平滑法/移动平均法(Moving average)</span><br><span class="line">ts_log_moving_avg_diff = ts_log - moving_avg #移除移动平均值</span><br><span class="line">ts_log_moving_avg_diff.dropna(inplace=True)</span><br><span class="line">test_stationarity(ts_log_moving_avg_diff) #平稳性检测</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Results of Dickey-Fuller Test:</span><br><span class="line">Test Statistic                  -3.162908</span><br><span class="line">p-value                          0.022235</span><br><span class="line"><span class="comment">#Lags Used                      13.000000</span></span><br><span class="line">Number of Observations Used    119.000000</span><br><span class="line">Critical Value (1%)             -3.486535</span><br><span class="line">Critical Value (5%)             -2.886151</span><br><span class="line">Critical Value (10%)            -2.579896</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p><strong>p &#x3D; 0.022235 &lt; 0.05 我们可以说在95%的置信度下该序列平稳，均值和方差比平滑法相对稳定</strong></p>
<p><em><strong>方法二：指数加权平滑法(exponentially weighted moving average)</strong></em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expwighted_avg = ts_log.ewm(min_periods=0, ignore_na=False, halflife=12, adjust=True).mean()</span><br><span class="line">ts_log_ewma_diff = ts_log - expwighted_avg</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Results of Dickey-Fuller Test:</span><br><span class="line">Test Statistic                  -3.601262</span><br><span class="line">p-value                          0.005737</span><br><span class="line"><span class="comment">#Lags Used                      13.000000</span></span><br><span class="line">Number of Observations Used    130.000000</span><br><span class="line">Critical Value (1%)             -3.481682</span><br><span class="line">Critical Value (5%)             -2.884042</span><br><span class="line">Critical Value (10%)            -2.578770</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p><strong>p &#x3D; 0.005737 现在可以说在99%的置信度下该序列平稳，均值和方差更加稳定</strong></p>
<h4 id="消除趋势和季节因素"><a href="#消除趋势和季节因素" class="headerlink" title="消除趋势和季节因素"></a>消除趋势和季节因素</h4><p>两个常用而且有效地方法来消除趋势项和季节性因素：差分，分解</p>
<ul>
<li>差分：以一定的时间间隔做差分</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一阶差分</span></span><br><span class="line">ts_log_diff = ts_log - ts_log.shift()</span><br><span class="line">ts_log_diff.dropna(inplace=True)</span><br><span class="line"><span class="comment">#平稳性检测</span></span><br><span class="line">test_stationarity(ts_log_diff)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Results of Dickey-Fuller Test:</span><br><span class="line">Test Statistic                  -2.717131</span><br><span class="line">p-value                          0.071121</span><br><span class="line"><span class="comment">#Lags Used                      14.000000</span></span><br><span class="line">Number of Observations Used    128.000000</span><br><span class="line">Critical Value (1%)             -3.482501</span><br><span class="line">Critical Value (5%)             -2.884398</span><br><span class="line">Critical Value (10%)            -2.578960</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">p = 0.071121 可以说在90%的置信度下该序列平稳，均值和方差很稳定**</span><br></pre></td></tr></table></figure>

<ul>
<li>分解：对趋势和季节性进行建模，并将它们从模型中移除</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from statsmodels.tsa.seasonal import seasonal_decompose</span><br><span class="line">decomposition = seasonal_decompose(ts_log)</span><br><span class="line"></span><br><span class="line">trend = decomposition.trend</span><br><span class="line">seasonal = decomposition.seasonal</span><br><span class="line">residual = decomposition.resid</span><br></pre></td></tr></table></figure>

<h4 id="确定p值和q值"><a href="#确定p值和q值" class="headerlink" title="确定p值和q值"></a>确定p值和q值</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ACF and PACF plots:</span></span><br><span class="line"><span class="comment"># 升级 statsmodels==0.14 ，numpy == 1.20.3</span></span><br><span class="line">from statsmodels.tsa.stattools import acf, pacf  </span><br><span class="line"></span><br><span class="line"><span class="comment"># ts_log_diff， log变换后做一阶差分后的时序</span></span><br><span class="line">lag_acf = acf(ts_log_diff, nlags=30)</span><br><span class="line">lag_pacf = pacf(ts_log_diff, nlags=30, method=<span class="string">&#x27;ols&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot ACF:</span></span><br><span class="line">plt.subplot(121)    </span><br><span class="line">plt.plot(lag_acf)</span><br><span class="line">plt.axhline(y=0,linestyle=<span class="string">&#x27;--&#x27;</span>,color=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.axhline(y=-1.96/np.sqrt(len(ts_log_diff)),linestyle=<span class="string">&#x27;--&#x27;</span>,color=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.axhline(y=1.96/np.sqrt(len(ts_log_diff)),linestyle=<span class="string">&#x27;--&#x27;</span>,color=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Autocorrelation Function&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot PACF:</span></span><br><span class="line">plt.subplot(122)</span><br><span class="line">plt.plot(lag_pacf)</span><br><span class="line">plt.axhline(y=0,linestyle=<span class="string">&#x27;--&#x27;</span>,color=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.axhline(y=-1.96/np.sqrt(len(ts_log_diff)),linestyle=<span class="string">&#x27;--&#x27;</span>,color=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.axhline(y=1.96/np.sqrt(len(ts_log_diff)),linestyle=<span class="string">&#x27;--&#x27;</span>,color=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Partial Autocorrelation Function&#x27;</span>)</span><br><span class="line">plt.tight_layout()</span><br></pre></td></tr></table></figure>

<p><img src="/images/time2.png" alt="image"></p>
<p>可以看到ACF和PACF分别在2阶的时候第一次落到置信区间内，p,q取值2</p>
<h4 id="ARIMA拟合，并还原"><a href="#ARIMA拟合，并还原" class="headerlink" title="ARIMA拟合，并还原"></a>ARIMA拟合，并还原</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from statsmodels.tsa.arima_model import ARIMA</span><br><span class="line"><span class="built_in">print</span>(ts_log.head())</span><br><span class="line"><span class="comment">#拟合</span></span><br><span class="line">model = ARIMA(ts_log, order=(2, 1, 2)).fit()</span><br><span class="line"><span class="comment">#样本外预测，forecast方法:arma_model.forecast(steps=1, exog=None, alpha=0.05)</span></span><br><span class="line">results_ARIMA = model.forecast(12)</span><br><span class="line"><span class="comment">#还原对数</span></span><br><span class="line">predictions_ARIMA = np.exp(results_ARIMA)</span><br><span class="line">plt.plot(ts)</span><br><span class="line">plt.plot(predictions_ARIMA)</span><br><span class="line"><span class="comment">#predict方法，可以用来预测任意的样本内和样本外的时间步长。利用全部样本，预测未来12个</span></span><br><span class="line">results_ARIMA = model.predict(1,len(ts),len(ts)+12)</span><br><span class="line"><span class="comment">#还原对数</span></span><br><span class="line">predictions_ARIMA = np.exp(results_ARIMA)</span><br><span class="line">plt.plot(ts)</span><br><span class="line">plt.plot(predictions_ARIMA)</span><br></pre></td></tr></table></figure>

<p><img src="/images/time5.png" alt="image"></p>
<h5 id="SARMAX拟合，预测并还原"><a href="#SARMAX拟合，预测并还原" class="headerlink" title="SARMAX拟合，预测并还原"></a>SARMAX拟合，预测并还原</h5><p>SARIMAX是在差分移动自回归模型（ARIMA）的基础上加上季节（S,Seasonal）和外部因素(X,eXogenous)。也就是说以ARIMA基础加上周期性和季节性，适用于时间序列中带有明显周期性和季节性特征的数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#原始数据</span></span><br><span class="line">ts = <span class="built_in">df</span>[<span class="string">&#x27;#Passengers&#x27;</span>]</span><br><span class="line"><span class="comment">#利用对数转换，消除趋势</span></span><br><span class="line">ts_log = np.log(ts)</span><br><span class="line"><span class="comment">#SARMAX</span></span><br><span class="line">import statsmodels.api as sm</span><br><span class="line"><span class="comment">#选择参数，拟合ts_log</span></span><br><span class="line"><span class="comment"># Fit the model，p,q参数选择order=(1,1,1) 季节性参数选择 seasonal_order=(1,0,0,12)</span></span><br><span class="line">mod = sm.tsa.statespace.SARIMAX(ts_log, order=(1,1,1), seasonal_order=(1,0,0,12), simple_differencing=True)</span><br><span class="line">res = mod.fit(disp=False)</span><br><span class="line"><span class="built_in">print</span>(res.summary())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预测未来12个值，In-sample one-step-ahead predictions, and out-of-sample forecasts</span></span><br><span class="line">nforecast = 12</span><br><span class="line">predict = res.get_prediction(end=mod.nobs + nforecast)</span><br><span class="line"><span class="comment"># 消除一阶差分的影响</span></span><br><span class="line">pred_log = pd.Series(ts_log.iloc[0], index=ts_log[[0]].index)</span><br><span class="line">pred_log = pred_log.add(predict.predicted_mean, fill_value=0).cumsum()</span><br><span class="line"><span class="comment"># 对数还原</span></span><br><span class="line">pred_ARIMA = np.exp(pred_log)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graph</span></span><br><span class="line">fig, ax = plt.subplots(figsize=(12,6))</span><br><span class="line">ax.xaxis.grid()</span><br><span class="line">ax.plot(ts, <span class="string">&#x27;k.&#x27;</span>)</span><br><span class="line"><span class="comment"># Plot</span></span><br><span class="line">ax.plot(pred_ARIMA[:-nforecast-1], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">ax.plot(pred_ARIMA[-nforecast-1:], <span class="string">&#x27;k--&#x27;</span>, linestyle=<span class="string">&#x27;--&#x27;</span>, linewidth=2)</span><br><span class="line">ax.set(title=<span class="string">&#x27;RMSE: &#123;:.4f&#125;&#x27;</span>.format(np.sqrt(<span class="built_in">sum</span>((pred_ARIMA[:-nforecast-<span class="number">1</span>]-ts)**<span class="number">2</span>)/len(ts))));</span><br></pre></td></tr></table></figure>

<p><img src="/images/time6.png" alt="image"></p>
<h4 id="使用auto-arima自动寻参"><a href="#使用auto-arima自动寻参" class="headerlink" title="使用auto_arima自动寻参"></a>使用auto_arima自动寻参</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;自动寻参，自动预测&quot;</span>)</span><br><span class="line">start_time = time.time() <span class="comment">#开始时间</span></span><br><span class="line">model = pm.auto_arima(ts,     </span><br><span class="line">                    ) <span class="comment">#模型初始化,什么都默认</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;best model：&quot;</span>, model) <span class="comment">#拟合出来最佳模型</span></span><br><span class="line">y_pred = model.predict(12) <span class="comment">#预测未来n_periods期</span></span><br><span class="line"></span><br><span class="line">end_time = time.time() <span class="comment">#结束时间</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cost time： &quot;</span>, end_time - start_time) <span class="comment">#耗时</span></span><br><span class="line">plt.plot(ts)</span><br><span class="line">plt.plot(y_pred)</span><br></pre></td></tr></table></figure>

<p>best model：  ARIMA(4,1,3)(0,0,0)[0]<br>cost time：  3.2301900386810303</p>
<p><img src="/images/time3.png" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;使用对数，超级自动寻参，自动预测&quot;</span>)</span><br><span class="line">start_time = time.time() <span class="comment">#开始时间</span></span><br><span class="line">model = pm.auto_arima(ts_log,</span><br><span class="line">                        start_p = 1, d= None, start_q = 1,          </span><br><span class="line">                        max_p = 5, max_d = 2, max_q = 5, </span><br><span class="line">                        start_P = 1, D = None, start_Q = 1,</span><br><span class="line">                        max_P = 2, max_D = 1, max_Q= 2,</span><br><span class="line">                        max_order = None,</span><br><span class="line">                        <span class="built_in">test</span> = <span class="string">&#x27;kpss&#x27;</span>,</span><br><span class="line">                        m =12,</span><br><span class="line">                        seasonal = True, </span><br><span class="line">                        seasonal_test= <span class="string">&#x27;ocsb&#x27;</span>,</span><br><span class="line">                        trend = <span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">                        information_criterion =<span class="string">&#x27;aic&#x27;</span>,</span><br><span class="line">                        trace = False,</span><br><span class="line">                        with_intercept = <span class="string">&#x27;auto&#x27;</span>, </span><br><span class="line">                        error_action = <span class="string">&#x27;ignore&#x27;</span>,  </span><br><span class="line">                        suppress_warnings = True,</span><br><span class="line">                        maxiter= 50,</span><br><span class="line">                        stepwise=False,</span><br><span class="line">                        n_jobs = -1</span><br><span class="line">                        ) <span class="comment">#模型初始化</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;best model：&quot;</span>, model) <span class="comment">#拟合出来最佳模型</span></span><br><span class="line">y_pred = model.predict(12) <span class="comment">#预测未来n_periods期</span></span><br><span class="line">end_time = time.time() <span class="comment">#结束时间</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cost time： &quot;</span>, end_time - start_time) <span class="comment">#耗时</span></span><br><span class="line">predictions_ARIMA_P = np.exp(y_pred)</span><br><span class="line">plt.plot(ts)</span><br><span class="line">plt.plot(predictions_ARIMA_P)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>best model：  ARIMA(2,0,0)(0,1,1)[12] intercept<br>cost time：  113.49449920654297</p>
<p><img src="/images/time4.png" alt="image"></p>
<p>参考：</p>
<p>1、<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40903057/article/details/95318891">时间序列分析 - AirPassenger_air_passenger.csv_涤生（bluez）的博客-CSDN博客</a></p>
<p>2、<a target="_blank" rel="noopener" href="https://blog.csdn.net/zengbowengood/article/details/125608252">时间序列分析|auto_arima调参_帅帅de三叔的博客-CSDN博客</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://vbrun-lab.github.io/2023/06/27/2023-06-27/" data-id="cljspi8490004p88bak1e29mx" data-title="时间序列（二）——复现ARIMA预测AirPassenger" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" rel="tag">时间序列</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/06/28/2023-06-28/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          时间序列（三）—— SARIMAX带有衍生变量的时间序列预测
        
      </div>
    </a>
  
  
    <a href="/2023/06/17/2023-06-17/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">时间序列学习（一）——基础</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" rel="tag">时间序列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" style="font-size: 20px;">时间序列</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 20px;">机器学习</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/06/28/2023-06-28/">时间序列（三）—— SARIMAX带有衍生变量的时间序列预测</a>
          </li>
        
          <li>
            <a href="/2023/06/27/2023-06-27/">时间序列（二）——复现ARIMA预测AirPassenger</a>
          </li>
        
          <li>
            <a href="/2023/06/17/2023-06-17/">时间序列学习（一）——基础</a>
          </li>
        
          <li>
            <a href="/2023/06/14/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/06/14/first-Blog/">搭建Hexo博客小屋</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>